<!--
file:///home/ywsing/suite/src/main/html/webassembly.html
-->
<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8' />
		<meta http-equiv='X-UA-Compatible' content='IE=edge'>
		<title>WebAssembly Demo</title>
		<meta name='viewport' content='width=device-width, initial-scale=1'>
	</head>
	<body>
		<h1>WebAssembly Demo</h1>
		<div id='target'></div>
	</body>
	<script src='eval-script.js'></script>
</html>

<script>
'use strict';

Promise.resolve(true)
.then(() => evalscriptglobal('fun.js', 'fun()'))
// .then(({ lens, range, read, }) => {
.then(() => evalscriptglobal('render.js', 'render()'))
// .then(({ rd, renderAgain, }) => {
.then(() => {
	let rd_vm = rd.parse(`
		<span>{ vm.result }</span>
	`);

	let buffer = new Uint8Array([
	0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x01, 0x86, 0x80, 0x80, 0x80, 0x00, 0x01, 0x60,
	0x01, 0x7f, 0x01, 0x7f, 0x03, 0x82, 0x80, 0x80, 0x80, 0x00, 0x01, 0x00, 0x04, 0x84, 0x80, 0x80,
	0x80, 0x00, 0x01, 0x70, 0x00, 0x00, 0x05, 0x83, 0x80, 0x80, 0x80, 0x00, 0x01, 0x00, 0x01, 0x06,
	0x81, 0x80, 0x80, 0x80, 0x00, 0x00, 0x07, 0x98, 0x80, 0x80, 0x80, 0x00, 0x02, 0x06, 0x6d, 0x65,
	0x6d, 0x6f, 0x72, 0x79, 0x02, 0x00, 0x0b, 0x5f, 0x5a, 0x37, 0x73, 0x71, 0x75, 0x61, 0x72, 0x65,
	0x72, 0x69, 0x00, 0x00, 0x0a, 0x8d, 0x80, 0x80, 0x80, 0x00, 0x01, 0x87, 0x80, 0x80, 0x80, 0x00,
	0x00, 0x20, 0x00, 0x20, 0x00, 0x6c, 0x0b,
	]).buffer;

	WebAssembly.compile(buffer).then(wasm => {
		let squarer = new WebAssembly.Instance(wasm).exports._Z7squareri;
		let result = 'Finished compiling! Ready when you are... 3^2 = ' + squarer(3);
		renderAgain(rd_vm, vm => ({ result: result, }));	
	});
});
</script>
