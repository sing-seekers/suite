<meta charset='utf-8'>
<!--
file:///home/ywsing/suite/src/main/html/block-fill.html
-->
<!DOCTYPE html>
<html>
	<body>
		<div id='target'></div>
	</body>

	<script src='eval-script.js'></script>

	<script type='text/javascript'>
'use strict';

evalscripts(['frp', 'fun', 'render'])
.then(({ frp, fun: { range, }, render: { rd, renderAgain, }, }) => {
	globalThis.handle = (() => {
		let vmsetcell = (vmt0, vmc1) =>  {
			let vmr0 = vmt0[vmc1.x];
			let vmc0 = vmr0[vmc1.y];
			let vmr1 = vmr0.map(vmc => vmc != vmc0 ? vmc : vmc1);
			let vmt1 = vmt0.map(vmr => vmr != vmr0 ? vmr : vmr1);
			return vmt1;
		};

		let dragsource = null;
		let dragtarget = null;

		return {
			click: (ev, vmc) => renderAgain(view, vm => vmsetcell(vm, { ...vmc, d: !vmc.d, })),
			dragend: (ev, vm) => {
				renderAgain(view, vm => {
					vm = vmsetcell(vm, { ...dragsource, d: dragtarget.d, });
					vm = vmsetcell(vm, { ...dragtarget, d: dragsource.d, });
					return vm;
				});
			},
			dragenter: (ev, vm) => dragtarget = vm,
			dragstart: (ev, vm) => dragsource = vm,
		};
	})();

	let viewCell = rd.parse({}, `
		<div draggable='true'
			rd_on_click='handle.click(ev, vm)'
			rd_on_dragend='handle.dragend(ev, vm)'
			rd_on_dragenter='handle.dragenter(ev, vm)'
			rd_on_dragexit='{}'
			rd_on_dragleave='{}'
			rd_on_dragover='{ ev.dataTransfer.dropEffect = "move"; }'
			rd_on_dragstart='handle.dragstart(ev, vm)'
			rd_on_drop='{}'
			style='
				background: { vm.d ? "#888888" : "#DDDDDD" };
				display: inline-block;
				font-size: 32px;
				height: 50px;
				text-align: center;
				vertical-align: middle;
				width: 50px;'>
			<rd_if v='vm.d'>ðŸ˜‚</rd_if>
			<rd_if v='!vm.d'>ðŸ’–</rd_if>
		</div>
	`);

	let view = rd.parse({ viewCell, }, `
		<span>
			<table style='font-family: monospace; font-size: 20; user-select: none;'>
				<rd_for>
					<tr>
						<rd_for>
							<td>
								<rd_view v='env.viewCell' />
							</td>
						</rd_for>
					</tr>
				</rd_for>
			</table>
			<button rd_on_click='closer()'>Close</button>
		</span>
	`);

	// let interval = setInterval(() => renderAgain(view, vm => { vm[1][1].d = !vm[1][1].d; return JSON.parse(JSON.stringify(vm)); }), 500);

	renderAgain(view, () => {
		var vm = range(0, 8).map(x => range(0, 8).map(y => ({ d: false, x, y, })).list()).list();
		vm[1][1].d = true;
		return vm;
	});

	globalThis.closer = () => {
		// clearInterval(interval);
		renderAgain(view, vm => null);
	};
})
.catch(console.error);
	</script>
</html>
